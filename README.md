# h3ws2h1ws-proxy

Прокси-сервер для WebSocket over HTTP/3 (RFC 9220) на входе и классического WebSocket over HTTP/1.1 на backend.

## Что умеет проект

- Принимать WebSocket-подключения через **HTTP/3 extended CONNECT**.
- Проксировать трафик между клиентом (H3 WS) и backend-сервисом (`ws://` или `wss://`).
- Ограничивать размер:
  - отдельного WebSocket frame (`max-frame`),
  - итогового сообщения (`max-message`).
- Ограничивать общее число одновременных сессий (`max-conns`).
- Проксировать control frames (`ping`, `pong`, `close`) и корректно завершать сессии.
- Отдавать Prometheus-метрики на отдельном HTTP endpoint (`/metrics`).

## Архитектура и назначение модулей

### `cmd/h3ws2h1ws-proxy/main.go`
Минимальная точка входа: вызывает `app.Run()` и завершает процесс при ошибке.

### `internal/run.go`
Bootstrap приложения:
- парсинг флагов,
- валидация backend URL,
- запуск metrics endpoint,
- создание и запуск HTTP/3 сервера.

### `internal/config/config.go`
Содержит:
- `Config` — конфигурация процесса (адреса, лимиты, таймауты),
- `Limits` — runtime-лимиты прокси,
- `DefaultTLSConfig()` — TLS 1.3 + ALPN для HTTP/3.

### `internal/metrics/metrics.go`
Определяет и регистрирует Prometheus-метрики:
- активные сессии,
- принятые/отклонённые подключения,
- ошибки по стадиям,
- объём и число проксируемых сообщений,
- control frames,
- дропы из-за лимитов.

### `internal/proxy/proxy.go`
Содержит основную логику установки сессии:
- проверка RFC9220-заголовков,
- ответ handshake (`Sec-WebSocket-Accept`),
- dial backend WS,
- запуск двунаправленных pump-потоков,
- жизненный цикл сессии и обработка ошибок.

### `internal/proxy/pumps.go`
Логика передачи данных:
- `pumpH3ToBackend` — из H3-потока в backend WebSocket,
- `pumpBackendToH3` — из backend WebSocket в H3-поток.

Включает:
- сборку фрагментированных сообщений,
- применение таймаутов,
- реакцию на `ping/pong/close`,
- проверки лимитов размеров.

### `internal/ws/framing.go`
Низкоуровневая реализация RFC6455:
- чтение frame (`ReadFrame`),
- запись data/control/close frame,
- фрагментация больших payload,
- маскирование/демаскирование,
- парсинг payload close frame.

### `internal/ws/utils.go`
Вспомогательные функции:
- `ComputeAccept` — расчёт `Sec-WebSocket-Accept`,
- `PickFirstToken` — выбор первого subprotocol,
- `IsNetClose` — эвристика «нормального» закрытия соединения.

## Запуск

### Требования
- Go 1.25+
- TLS-сертификат и ключ (`cert.pem`, `key.pem`) для HTTP/3 сервера.

### Пример

```bash
go run ./cmd/h3ws2h1ws-proxy \
  -listen :443 \
  -cert cert.pem \
  -key key.pem \
  -backend ws://127.0.0.1:8080/ws \
  -path /ws \
  -metrics 127.0.0.1:9090
```

## Основные флаги

- `-listen` — UDP адрес HTTP/3 сервера (по умолчанию `:443`)
- `-cert` / `-key` — TLS сертификат и ключ
- `-backend` — URL backend WebSocket (`ws://` или `wss://`)
- `-path` — путь для RFC9220 CONNECT (по умолчанию `/ws`)
- `-metrics` — адрес endpoint метрик (по умолчанию `127.0.0.1:9090`)
- `-max-frame` — максимум байт в одном frame
- `-max-message` — максимум байт в одном собранном сообщении
- `-max-conns` — максимум одновременных сессий
- `-read-timeout` / `-write-timeout` — таймауты чтения/записи

## Метрики

Endpoint: `http://<metrics-addr>/metrics`

Ключевые метрики:
- `h3ws_proxy_active_sessions`
- `h3ws_proxy_accepted_total`
- `h3ws_proxy_rejected_total{reason=...}`
- `h3ws_proxy_errors_total{stage=...}`
- `h3ws_proxy_bytes_total{dir=...}`
- `h3ws_proxy_messages_total{dir=...,type=...}`
- `h3ws_proxy_control_frames_total{type=...}`
- `h3ws_proxy_oversize_drops_total{kind=...}`

## Docker + Grafana

Добавлены файлы для локального observability-стека:

- `Dockerfile` — сборка и запуск прокси в контейнере.
- `docker-compose.yml` — запуск `h3ws-proxy`, `prometheus`, `grafana`.
- `deploy/prometheus/prometheus.yml` — scrape-конфиг Prometheus.
- `deploy/grafana/provisioning/datasources/prometheus.yml` — datasource provisioning.
- `deploy/grafana/provisioning/dashboards/dashboards.yml` — auto-import dashboard.
- `deploy/grafana/dashboards/h3ws-proxy-overview.json` — готовый dashboard для метрик прокси.

Запуск:

```bash
docker compose up --build
```

После запуска:

- Grafana: `http://localhost:3000` (`admin/admin`)
- Prometheus: `http://localhost:9091`
- Proxy metrics: `http://localhost:9090/metrics`

> В compose-конфигурации при первом старте автоматически генерируется self-signed TLS сертификат в `./certs`.
